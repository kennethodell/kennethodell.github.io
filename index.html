<!DOCTYPE html>
<html>
  <head>
    <title>How Happy Are We In The United States?</title>
	<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
	<style type="text/css">
body {
	color : gray;
}

#header {
	text-align: center;
	margin: auto;

}

#header-title {
	color: gray;
}

circle {fill: lightblue; stroke: black;}

.line {
	fill: none;
	stroke: steelblue;
	stroke-width: 1.5px;
}
	</style>

  </head>
  <body onload='init()'>
	<div id="header">
	  <h1 id="header-title">How Happy Are We?</h1>
	</div>
	<div id="narrative">
		<p>The <span class="cite"><a href="https://worldhappiness.report" target="_blank">World Happiness Report 2019</a></span> is a survey that ranks 156 countries by a subjective measure of happiness.
			This data comes from the Gallup World Poll.  Based on this data, we want to know if the United States has been getting any happier during the last ten years?
		</p>
		<p id="comment">
			Press the 'Next' button to get started
		</p>
	</div>
	<div id="control">
	  <button id="prev" name="prev" type="button" onclick="previousClick()">Previous</button>
	  <button id="next" name="next" type="button" onclick="nextClick()">Next</button>
	</div>
	<div id="canvas">
		<svg>
		</svg>
	</div>
	
	<script>

const MIN_YEAR = 2008;
const MAX_YEAR = 2018;

var dataSrc = 'https://kennethodell.github.io/Chapter2OnlineData.csv';

var margin = { top:50, right:50, bottom:50, left:50};
var width= window.innerWidth - margin.left - margin.right;
var height=600;

var xscale = d3.scaleLinear().domain([MIN_YEAR,MAX_YEAR]).range([0, width]);
var yscale = d3.scaleLinear().domain([0,10]).range([height, 0]);
var rscale = d3.scaleLinear().domain([0,12]).range([0, 10]);

var chartParams = {
	"minYear": MIN_YEAR,
	"maxYear": MAX_YEAR,

	"currentYear": null,

	"allData": null,

	"svg": null,

	"line": null,

	"countries": [
		"United States"
	],

	// https://stackoverflow.com/questions/10615290/select-data-from-a-csv-before-loading-it-with-javascript-d3-library
	"filters": {
		'year': [2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018],
		'country': ['United States']
	}
};

function redraw(dataSet) {
	//console.log("redraw() called...");
	//console.log("Data: " + dataSet);

	var t = d3.transition().duration(500);

	var points = chartParams.svg.selectAll("circle").data(dataSet);
	var paths = chartParams.svg.selectAll("path").data(dataSet);

	points.exit()
			.transition(t)
			.attr("r", 0)
			.remove()
			;

	// paths.exit()
	// 		.transition(t)
	// 		.attr("d", 0)
	// 		.remove()
	// 		;

	points.enter()
			.append("circle")
			.attr("class", "point")
			.attr("cx", function(d,i) { var x = xscale(d.year); console.log("Year=" + d.year + " cx=" + x); return x; })
			.attr("cy", function(d,i) { var y = yscale(d.happiness); console.log("LifeLadder=" + d.happiness + " cy=" + y); return y; })
			.transition(t)
			.attr("r", function(d,i) { var r = rscale(d.gdp); console.log("GDP=" + d.gdp + " r=" + r); return r; })
			;

	// paths.enter()
	// 		.append("path")
	// 		.attr("class", "line")
	// 		.attr("d", chartParams.line)
	// 		;

}

function previousClick() {

	if (chartParams.currentYear > MIN_YEAR) {
		chartParams.currentYear -= 1;
		console.log("Current year: " + chartParams.currentYear);

		dataSet = filterData(chartParams.allData, chartParams);
		redraw(dataSet);
	}
}

function nextClick() {

	var updated = false;
	if (chartParams.currentYear == null) {
		chartParams.currentYear = MIN_YEAR;
		updated = true;
	}
	else if (chartParams.currentYear < MAX_YEAR) {
		chartParams.currentYear += 1;
		updated = true;
	}

	if (updated) {
		console.log("Current year: " + chartParams.currentYear);
		dataSet = filterData(chartParams.allData, chartParams);
		redraw(dataSet)
	}
}

function filterData(data, filters) {

	var filteredData = data.filter(function (entry) {
		return entry.country === 'United States' && entry.year >= MIN_YEAR && entry.year <= filters.currentYear;
	});

	return filteredData;
}

async function init() {

	//var startRadius = 2;
	//var xticks = [2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018];
	//var yticks = [5, 6, 7, 8];
	//var n = 11;

	//var tFormat = "~s";

	// ----------------------------------------------------------------------------

	chartParams.allData = await d3.csv(dataSrc,
		function (d) {
			return {
				'year': +d.Year,
				'country': d.Country,
				'happiness': +d.LifeLadder,
				'gdp': +d.LogGDPPerCapita
			};
		}
	);

	//var dataSet = filterData(chartParams.allData, chartParams);

	var svg = d3.select("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + ", " + margin.right + ")");

	chartParams.svg = svg;

	svg.append("g")
			.attr("class", "x-axis")
			.attr("transform", "translate(0, " + (height) + ")")
			.call(d3.axisBottom(xscale)); //.tickValues(xticks));

	svg.append("g")
			.attr("class", "y-axis")
			//.attr("transform", "translate(" + margin.top + "," + margin.top + ")")
			.call(d3.axisLeft(yscale)); //.tickValues(yticks).tickFormat(d3.format(tFormat)));

	chartParams.line = d3.line()
			.curve(d3.curveBasis)
			.x(function(d) { var x = xscale(d.year); console.log("Line: " + x); return x; })
			.y(function(d) { var y = yscale(d.happiness); return y; });

	/*
	chartParams.svg.selectAll("circle")
			.data(dataSet)
			.enter()
			.append("circle")
			.attr("cx", function(d,i) { var x = xscale(d.year); console.log("Year=" + d.year + " cx=" + x); return x; })
			.attr("cy", function(d,i) { var y = yscale(d.happiness); console.log("LifeLadder=" + d.happiness + " cy=" + y); return y; })
			.attr("r", function(d,i) { var r = rscale(d.gdp); console.log("GDP=" + d.gdp + " r=" + r); return r; })
			;
	*/
}
</script>

	<footer>
		<p>Posted by: Ken O'Dell</p>
		<p>Sources:</p>
		<p><a href="https://worldhappiness.report/ed/2019/">World Happiness Report 2019</a>.</p>
	</footer>
  </body>
</html>
